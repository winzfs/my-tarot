<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARCANA TAROT | ì‹ ë¹„ë¡œìš´ íƒ€ë¡œì </title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #e2b857;
            --gold-glow: rgba(226, 184, 87, 0.3);
            --bg-dark: #0a0a0c;
            --glass: rgba(255, 255, 255, 0.05);
        }

        body {
            background: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 20%, #1a1a2e 0%, var(--bg-dark) 80%);
            color: #e0e0e0;
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem; letter-spacing: 5px; color: var(--gold);
            margin: 40px 0; text-shadow: 0 0 15px var(--gold-glow);
        }

        /* ê²Œì„ ì»¨í…Œì´ë„ˆ */
        #game-container {
            width: 100%; max-width: 600px; height: 350px;
            background: #050505; border: 2px solid var(--gold);
            margin: 20px 0; position: relative; border-radius: 15px;
            overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #gameCanvas { width: 100%; height: 100%; image-rendering: pixelated; }
        #game-ui {
            position: absolute; bottom: 15px; width: 100%; text-align: center;
            color: var(--gold); font-family: 'Cinzel', serif; font-size: 0.9rem;
            text-shadow: 0 0 5px black; pointer-events: none;
        }

        /* ì…ë ¥ ì˜ì—­ */
        #input-area, #mode-selection {
            width: 100%; max-width: 600px; display: none; margin-bottom: 30px;
        }

        .user-info-group {
            display: flex; gap: 10px; margin-bottom: 10px;
        }

        input[type="text"], input[type="date"] {
            width: 100%; padding: 15px; border-radius: 10px; border: 1px solid var(--gold);
            background: var(--glass); color: white; text-align: center; font-size: 1rem;
            outline: none; box-sizing: border-box;
        }

        /* ëª¨ë“œ ì„ íƒ */
        .mode-card {
            background: var(--glass); border: 1px solid var(--gold);
            padding: 30px; margin: 15px 10px; border-radius: 20px; cursor: pointer;
            transition: all 0.4s ease; width: 250px; display: inline-block;
            vertical-align: top; backdrop-filter: blur(5px); text-align: center;
        }
        .mode-card:hover { background: rgba(226, 184, 87, 0.1); transform: translateY(-10px); box-shadow: 0 10px 20px var(--gold-glow); }
        .mode-card h2 { color: var(--gold); font-family: 'Cinzel', serif; margin-top: 0; }

        /* íƒ€ë¡œ ìŠ¤í…Œì´ì§€ */
        #tarot-stage { display: none; width: 100%; max-width: 800px; margin: 0 auto; text-align: center; }
        .cards-container { display: flex; justify-content: center; gap: 20px; margin: 40px 0; flex-wrap: wrap; }
        .card-wrapper { flex: 0 0 160px; text-align: center; }
        .label { font-family: 'Cinzel', serif; color: var(--gold); font-size: 0.9rem; margin-bottom: 15px; height: 2.5rem; display: flex; align-items: center; justify-content: center; }
        .card-display { width: 100%; height: 260px; perspective: 1000px; }
        .card-inner { width: 100%; height: 100%; position: relative; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; cursor: pointer; }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 15px; border: 1px solid var(--gold); overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .card-front { background: #1a1a2e; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: var(--gold); }
        .card-back { transform: rotateY(180deg); background: white; }
        .card-back img { width: 100%; height: 100%; object-fit: cover; }

        .result-text { width: 100%; max-width: 700px; margin: 40px auto; padding: 35px; background: var(--glass); backdrop-filter: blur(10px); border: 1px solid var(--gold-glow); border-radius: 25px; box-sizing: border-box; }
        .name { font-family: 'Cinzel', serif; font-size: 1.6rem; color: var(--gold); margin-bottom: 20px; }
        .desc { font-size: 1.05rem; line-height: 1.8; color: #ddd; white-space: pre-wrap; word-break: keep-all; }
        
        button.nav-btn { margin-top: 30px; padding: 12px 35px; background: none; border: 1px solid var(--gold); color: var(--gold); border-radius: 50px; cursor: pointer; transition: 0.3s; font-family: 'Cinzel', serif; letter-spacing: 1px; }
        button.nav-btn:hover { background: var(--gold); color: black; }
    </style>
</head>
<body>

    <audio id="bgm" loop><source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-17.mp3"></audio>
    <audio id="sfx-flip"><source src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>

    <h1>ARCANUM TAROT</h1>

    <div id="game-container">
        <canvas id="gameCanvas" width="600" height="350"></canvas>
        <div id="game-ui">â–² í™”ì‚´í‘œ í‚¤ë¡œ ì›€ì§ì—¬ ì ì„±ìˆ ì‚¬(í™©ê¸ˆìƒ‰)ì—ê²Œ ë‹¤ê°€ê°€ì„¸ìš”</div>
    </div>

    <div id="input-area">
        <div class="user-info-group">
            <input type="text" id="user-name" placeholder="ë‹¹ì‹ ì˜ ì´ë¦„">
            <input type="date" id="user-birth">
        </div>
        <input type="text" id="user-question" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
    </div>

    <div id="mode-selection">
        <div class="mode-card" onclick="startTarot(1)">
            <h2>ì› ì¹´ë“œ</h2>
            <p>ì˜¤ëŠ˜ì˜ ìš´ì„¸ë‚˜ ë‹¨ìˆœí•œ ì¡°ì–¸</p>
        </div>
        <div class="mode-card" onclick="startTarot(3)">
            <h2>ì“°ë¦¬ ì¹´ë“œ</h2>
            <p>ê³¼ê±°-í˜„ì¬-ë¯¸ë˜ì˜ íë¦„ ë¶„ì„</p>
        </div>
    </div>

    <div id="tarot-stage">
        <div class="cards-container" id="cards-container"></div>
        <div class="result-text" id="result-text">
            <div id="res-name" class="name">ì¹´ë“œë¥¼ ë’¤ì§‘ì–´ì£¼ì„¸ìš”</div>
            <div id="res-desc" class="desc">ê° ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ AIì˜ ì‹ íƒì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
        </div>
        <button class="nav-btn" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <script>
        const imgBase = "https://commons.wikimedia.org/wiki/Special:FilePath/";
        const tarotData = [
            // ë©”ì´ì € ì•„ë¥´ì¹´ë‚˜ (0~21)
            { name: "0. ê´‘ëŒ€", img: "RWS_Tarot_00_Fool.jpg" }, { name: "1. ë§ˆë²•ì‚¬", img: "RWS_Tarot_01_Magician.jpg" },
            { name: "2. ê³ ìœ„ ì—¬ì‚¬ì œ", img: "RWS_Tarot_02_High_Priestess.jpg" }, { name: "3. ì—¬í™©ì œ", img: "RWS_Tarot_03_Empress.jpg" },
            { name: "4. í™©ì œ", img: "RWS_Tarot_04_Emperor.jpg" }, { name: "5. êµí™©", img: "RWS_Tarot_05_Hierophant.jpg" },
            { name: "6. ì—°ì¸", img: "RWS_Tarot_06_Lovers.jpg" }, { name: "7. ì „ì°¨", img: "RWS_Tarot_07_Chariot.jpg" },
            { name: "8. í˜", img: "RWS_Tarot_08_Strength.jpg" }, { name: "9. ì€ë‘”ì", img: "RWS_Tarot_09_Hermit.jpg" },
            { name: "10. ìš´ëª…ì˜ ìˆ˜ë ˆë°”í€´", img: "RWS_Tarot_10_Wheel_of_Fortune.jpg" }, { name: "11. ì •ì˜", img: "RWS_Tarot_11_Justice.jpg" },
            { name: "12. ë§¤ë‹¬ë¦° ì‚¬ëŒ", img: "RWS_Tarot_12_Hanged_Man.jpg" }, { name: "13. ì£½ìŒ", img: "RWS_Tarot_13_Death.jpg" },
            { name: "14. ì ˆì œ", img: "RWS_Tarot_14_Temperance.jpg" }, { name: "15. ì•…ë§ˆ", img: "RWS_Tarot_15_Devil.jpg" },
            { name: "16. íƒ‘", img: "RWS_Tarot_16_Tower.jpg" }, { name: "17. ë³„", img: "RWS_Tarot_17_Star.jpg" },
            { name: "18. ë‹¬", img: "RWS_Tarot_18_Moon.jpg" }, { name: "19. íƒœì–‘", img: "RWS_Tarot_19_Sun.jpg" },
            { name: "20. ì‹¬íŒ", img: "RWS_Tarot_20_Judgement.jpg" }, { name: "21. ì„¸ê³„", img: "RWS_Tarot_21_World.jpg" },

            // ì™„ë“œ (Wands)
            { name: "ì™„ë“œ ì—ì´ìŠ¤", img: "Wands01.jpg" }, { name: "ì™„ë“œ 2", img: "Wands02.jpg" },
            { name: "ì™„ë“œ 3", img: "Wands03.jpg" }, { name: "ì™„ë“œ 4", img: "Wands04.jpg" },
            { name: "ì™„ë“œ 5", img: "Wands05.jpg" }, { name: "ì™„ë“œ 6", img: "Wands06.jpg" },
            { name: "ì™„ë“œ 7", img: "Wands07.jpg" }, { name: "ì™„ë“œ 8", img: "Wands08.jpg" },
            { name: "ì™„ë“œ 9", img: "Tarot_Nine_of_Wands.jpg" }, { name: "ì™„ë“œ 10", img: "Wands10.jpg" },
            { name: "ì™„ë“œ ì‹œì¢…", img: "Wands11.jpg" }, { name: "ì™„ë“œ ê¸°ì‚¬", img: "Wands12.jpg" },
            { name: "ì™„ë“œ í€¸", img: "Wands13.jpg" }, { name: "ì™„ë“œ í‚¹", img: "Wands14.jpg" },

            // ì»µ (Cups)
            { name: "ì»µ ì—ì´ìŠ¤", img: "Cups01.jpg" }, { name: "ì»µ 2", img: "Cups02.jpg" },
            { name: "ì»µ 3", img: "Cups03.jpg" }, { name: "ì»µ 4", img: "Cups04.jpg" },
            { name: "ì»µ 5", img: "Cups05.jpg" }, { name: "ì»µ 6", img: "Cups06.jpg" },
            { name: "ì»µ 7", img: "Cups07.jpg" }, { name: "ì»µ 8", img: "Cups08.jpg" },
            { name: "ì»µ 9", img: "Cups09.jpg" }, { name: "ì»µ 10", img: "Cups10.jpg" },
            { name: "ì»µ ì‹œì¢…", img: "Cups11.jpg" }, { name: "ì»µ ê¸°ì‚¬", img: "Cups12.jpg" },
            { name: "ì»µ í€¸", img: "Cups13.jpg" }, { name: "ì»µ í‚¹", img: "Cups14.jpg" },

            // ì†Œë“œ (Swords)
            { name: "ì†Œë“œ ì—ì´ìŠ¤", img: "Swords01.jpg" }, { name: "ì†Œë“œ 2", img: "Swords02.jpg" },
            { name: "ì†Œë“œ 3", img: "Swords03.jpg" }, { name: "ì†Œë“œ 4", img: "Swords04.jpg" },
            { name: "ì†Œë“œ 5", img: "Swords05.jpg" }, { name: "ì†Œë“œ 6", img: "Swords06.jpg" },
            { name: "ì†Œë“œ 7", img: "Swords07.jpg" }, { name: "ì†Œë“œ 8", img: "Swords08.jpg" },
            { name: "ì†Œë“œ 9", img: "Swords09.jpg" }, { name: "ì†Œë“œ 10", img: "Swords10.jpg" },
            { name: "ì†Œë“œ ì‹œì¢…", img: "Swords11.jpg" }, { name: "ì†Œë“œ ê¸°ì‚¬", img: "Swords12.jpg" },
            { name: "ì†Œë“œ í€¸", img: "Swords13.jpg" }, { name: "ì†Œë“œ í‚¹", img: "Swords14.jpg" },

            // íœíƒ€í´ (Pentacles)
            { name: "íœíƒ€í´ ì—ì´ìŠ¤", img: "Pents01.jpg" }, { name: "íœíƒ€í´ 2", img: "Pents02.jpg" },
            { name: "íœíƒ€í´ 3", img: "Pents03.jpg" }, { name: "íœíƒ€í´ 4", img: "Pents04.jpg" },
            { name: "íœíƒ€í´ 5", img: "Pents05.jpg" }, { name: "íœíƒ€í´ 6", img: "Pents06.jpg" },
            { name: "íœíƒ€í´ 7", img: "Pents07.jpg" }, { name: "íœíƒ€í´ 8", img: "Pents08.jpg" },
            { name: "íœíƒ€í´ 9", img: "Pents09.jpg" }, { name: "íœíƒ€í´ 10", img: "Pents10.jpg" },
            { name: "íœíƒ€í´ ì‹œì¢…", img: "Pents11.jpg" }, { name: "íœíƒ€í´ ê¸°ì‚¬", img: "Pents12.jpg" },
            { name: "íœíƒ€í´ í€¸", img: "Pents13.jpg" }, { name: "íœíƒ€í´ í‚¹", img: "Pents14.jpg" }
        ];

        let selectedCards = [];
        let totalCount = 0;

        function startTarot(count) {
            totalCount = count;
            selectedCards = [];
            document.getElementById('mode-selection').style.display = 'none';
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('tarot-stage').style.display = 'block';
            
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            const labels = count === 3 ? ["ê³¼ê±°", "í˜„ì¬", "ë¯¸ë˜"] : ["ì˜¤ëŠ˜ì˜ ì‹ íƒ"];

            for(let i=0; i<count; i++) {
                container.innerHTML += `
                    <div class="card-wrapper">
                        <div class="label">${labels[i]}</div>
                        <div class="card-display">
                            <div class="card-inner" onclick="flipCard(this, ${i})">
                                <div class="card-face card-front">âœ¦</div>
                                <div class="card-face card-back" id="back-${i}"></div>
                            </div>
                        </div>
                    </div>`;
            }
        }

        async function flipCard(el, idx) {
            if (el.classList.contains('is-flipped')) return;
            document.getElementById('bgm').play().catch(() => {});
            document.getElementById('sfx-flip').currentTime = 0;
            document.getElementById('sfx-flip').play();

            const card = tarotData[Math.floor(Math.random() * tarotData.length)];
            const isReverse = Math.random() > 0.3;
            const cardDisplayName = card.name + (isReverse ? " (ì—­ë°©í–¥)" : " (ì •ë°©í–¥)");

            const labelElement = el.closest('.card-wrapper').querySelector('.label');
            labelElement.innerText = cardDisplayName;

            const back = document.getElementById(`back-${idx}`);
            back.innerHTML = `<img src="${imgBase}${card.img}" style="${isReverse ? 'transform:rotate(180deg)' : ''}; width:100%; height:100%; object-fit:cover;">`;
            el.classList.add('is-flipped');
            selectedCards.push(cardDisplayName);

            if (selectedCards.length === totalCount) showFinalReadButton();
        }

        function showFinalReadButton() {
            const resDesc = document.getElementById('res-desc');
            resDesc.innerHTML = `<button id="total-read-btn" class="nav-btn" style="background:var(--gold); color:black; font-weight:bold;" onclick="getFinalAIReading()">âœ¨ ì‹ íƒ í•´ì„ ë³´ê¸°</button>`;
        }

        async function getFinalAIReading() {
            const userName = document.getElementById('user-name').value || "ìµëª…ì˜ ì—¬í–‰ì";
            const userBirth = document.getElementById('user-birth').value;
            const question = document.getElementById('user-question').value || "ë‚˜ì˜ ìš´ì„¸ì— ëŒ€í•´";
            const resName = document.getElementById('res-name');
            const resDesc = document.getElementById('res-desc');
            const btn = document.getElementById('total-read-btn');

            btn.disabled = true;
            btn.innerText = "ğŸ”® ìš°ì£¼ì˜ íë¦„ì„ ì½ëŠ” ì¤‘...";

            try {
                const response = await fetch('/api/read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: userName, birth: userBirth, question: question, cards: selectedCards })
                });
                const data = await response.json();
                resName.innerText = `${userName}ë‹˜ì„ ìœ„í•œ ì‹ íƒ`;
                resDesc.innerText = data.text;
                btn.style.display = 'none';
            } catch (e) {
                resDesc.innerText = "í•´ì„ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                btn.disabled = false;
                btn.innerText = "ë‹¤ì‹œ ì‹œë„í•˜ê¸°";
            }
        }

        // --- í”½ì…€ ê²Œì„ ë¡œì§ ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const player = { x: 50, y: 175, size: 20, speed: 4, color: '#4a90e2' };
        const oracle = { x: 500, y: 155, size: 40, color: '#e2b857' };
        let keys = {};

        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        function gameLoop() {
            if (keys['ArrowUp'] && player.y > 0) player.y -= player.speed;
            if (keys['ArrowDown'] && player.y < canvas.height - player.size) player.y += player.speed;
            if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed;
            if (keys['ArrowRight'] && player.x < canvas.width - player.size) player.x += player.speed;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#1a1a2e';
            for(let i=0; i<canvas.width; i+=40) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i, canvas.height); ctx.stroke(); }
            
            ctx.fillStyle = oracle.color; ctx.fillRect(oracle.x, oracle.y, oracle.size, oracle.size);
            ctx.fillStyle = player.color; ctx.fillRect(player.x, player.y, player.size, player.size);

            const dist = Math.sqrt(Math.pow(player.x - oracle.x, 2) + Math.pow(player.y - oracle.y, 2));
            if (dist < 40) {
                document.getElementById('game-container').style.display = 'none';
                document.getElementById('input-area').style.display = 'block';
                document.getElementById('mode-selection').style.display = 'block';
                return;
            }
            requestAnimationFrame(gameLoop);
        }
        gameLoop();
    </script>
</body>
</html>
