<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCANA TAROT | ì‹ ë¹„ë¡œìš´ íƒ€ë¡œì </title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #e2b857;
            --gold-glow: rgba(226, 184, 87, 0.4);
            --bg-dark: #0a0a0c;
            --glass: rgba(255, 255, 255, 0.05);
        }

        body {
            background: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 20%, #1a1a2e 0%, var(--bg-dark) 80%);
            color: #e0e0e0; font-family: 'Noto Sans KR', sans-serif;
            margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overflow-x: hidden;
        }

        h1 {
            font-family: 'Cinzel', serif; font-size: 1.8rem; letter-spacing: 3px; color: var(--gold);
            margin: 15px 0; text-shadow: 0 0 10px var(--gold-glow); text-align: center;
        }

        /* ê²Œì„ ì˜ì—­ */
        #game-container {
            width: 100%; max-width: 500px; height: 320px;
            background: #000; border: 2px solid var(--gold);
            margin: 0 auto; position: relative; border-radius: 15px;
            overflow: hidden; box-shadow: 0 0 25px rgba(0,0,0,0.7);
            touch-action: none;
        }
        #gameCanvas { width: 100%; height: 100%; display: block; image-rendering: pixelated; }

        /* ì»¨íŠ¸ë¡¤ëŸ¬ */
        #mobile-controls {
            display: grid; grid-template-columns: repeat(3, 65px); grid-template-rows: repeat(2, 65px);
            gap: 10px; justify-content: center; margin-top: 15px;
        }
        .ctrl-btn {
            width: 65px; height: 65px; background: var(--glass); border: 1px solid var(--gold);
            border-radius: 50%; color: var(--gold); display: flex; align-items: center;
            justify-content: center; font-size: 1.2rem; user-select: none;
            backdrop-filter: blur(5px); transition: 0.1s;
        }
        .ctrl-btn:active { background: var(--gold); color: black; transform: scale(0.9); }

        /* UI ì˜ì—­ */
        #ui-layer { display: none; width: 100%; max-width: 500px; margin-top: 20px; }
        .user-info-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input { width: 100%; padding: 14px; border-radius: 8px; border: 1px solid var(--gold); background: var(--glass); color: white; outline: none; box-sizing: border-box; }
        
        .mode-card {
            background: var(--glass); border: 1px solid var(--gold); padding: 20px; margin-bottom: 15px;
            border-radius: 15px; cursor: pointer; text-align: center; transition: 0.3s;
        }
        .mode-card:hover { background: rgba(226, 184, 87, 0.1); }

        .cards-container { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
        .card-wrapper { width: 100px; perspective: 1000px; }
        .card-inner { width: 100%; height: 150px; position: relative; transition: 0.8s; transform-style: preserve-3d; cursor: pointer; }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; border: 1px solid var(--gold); }
        .card-front { background: #1a1a2e; display: flex; align-items: center; justify-content: center; color: var(--gold); font-size: 1.5rem; }
        .card-back { transform: rotateY(180deg); background: white; overflow: hidden; }
        .card-back img { width: 100%; height: 100%; object-fit: cover; }

        .result-text { background: var(--glass); padding: 20px; border-radius: 15px; border: 1px solid var(--gold-glow); line-height: 1.8; margin-top: 15px; white-space: pre-wrap; }
        .btn { background: var(--gold); color: black; border: none; padding: 15px 25px; border-radius: 30px; font-weight: bold; cursor: pointer; margin-top: 15px; width: 100%; }
    </style>
</head>
<body>

    <h1>ARCANUM TAROT</h1>

    <div id="game-wrapper" style="width:100%; max-width:500px;">
        <div id="game-container">
            <canvas id="gameCanvas" width="500" height="320"></canvas>
        </div>
        <div id="mobile-controls">
            <div class="ctrl-btn" style="grid-column:2" ontouchstart="keys['ArrowUp']=true" ontouchend="keys['ArrowUp']=false">â–²</div>
            <div class="ctrl-btn" style="grid-column:1; grid-row:2" ontouchstart="keys['ArrowLeft']=true" ontouchend="keys['ArrowLeft']=false">â—€</div>
            <div class="ctrl-btn" style="grid-column:2; grid-row:2" ontouchstart="keys['ArrowDown']=true" ontouchend="keys['ArrowDown']=false">â–¼</div>
            <div class="ctrl-btn" style="grid-column:3; grid-row:2" ontouchstart="keys['ArrowRight']=true" ontouchend="keys['ArrowRight']=false">â–¶</div>
        </div>
    </div>

    <div id="ui-layer">
        <div id="step-input">
            <div class="user-info-group">
                <input type="text" id="user-name" placeholder="ì´ë¦„">
                <input type="date" id="user-birth">
            </div>
            <input type="text" id="user-q" placeholder="ë¬´ì—‡ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?">
            <div style="margin-top:20px;">
                <div class="mode-card" onclick="startTarot(1)"><h3>ì˜¤ëŠ˜ì˜ ìš´ì„¸ (1ì¥)</h3></div>
                <div class="mode-card" onclick="startTarot(3)"><h3>ê³¼ê±°Â·í˜„ì¬Â·ë¯¸ë˜ (3ì¥)</h3></div>
            </div>
        </div>

        <div id="step-tarot" style="display:none;">
            <div class="cards-container" id="cards-box"></div>
            <div class="result-text" id="status-msg">ì¹´ë“œë¥¼ í´ë¦­í•˜ì—¬ ìš´ëª…ì„ í™•ì¸í•˜ì„¸ìš”.</div>
            <button id="interpret-btn" class="btn" style="display:none;" onclick="getAIInterpretation()">ìš´ëª…ì˜ í•´ì„ ë“£ê¸°</button>
            <button class="btn" style="background:#444; color:white;" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- ì´ë¯¸ì§€ ë¦¬ì†ŒìŠ¤ ---
        const imgBg = new Image();
        imgBg.src = 'https://img.freepik.com/free-photo/mystical-astrology-scene-with-stars_23-2151243469.jpg';
        
        const imgPlayer = new Image();
        imgPlayer.src = 'https://raw.githubusercontent.com/uheartbeast/youtube-tutorials/master/Action%20RPG/Characters/Player.png';

        const imgNpc = new Image();
        imgNpc.src = 'https://raw.githubusercontent.com/Deykun/Deykun.github.io/master/assets/images/posts/2019-10-14-rpg-maker-vx-ace-character-generator-guide/hero2.png';

        let keys = {};
        const player = { x: 50, y: 180, frame: 0, dir: 0, speed: 4 };
        const npc = { x: 400, y: 140 };

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.globalAlpha = 0.7;
            ctx.drawImage(imgBg, 0, 0, 500, 320);
            ctx.globalAlpha = 1.0;

            // NPC (ë§ˆë²•ì‚¬)
            if(imgNpc.complete) ctx.drawImage(imgNpc, 32, 0, 32, 32, npc.x, npc.y, 60, 60);

            // ì´ë™ ì²˜ë¦¬
            let moving = false;
            if (keys['ArrowUp'] && player.y > 90) { player.y -= player.speed; player.dir = 3; moving = true; }
            if (keys['ArrowDown'] && player.y < 260) { player.y += player.speed; player.dir = 0; moving = true; }
            if (keys['ArrowLeft'] && player.x > 0) { player.x -= player.speed; player.dir = 1; moving = true; }
            if (keys['ArrowRight'] && player.x < 440) { player.x += player.speed; player.dir = 2; moving = true; }

            // í”Œë ˆì´ì–´ ê·¸ë¦¬ê¸°
            if(moving) player.frame = Math.floor(Date.now()/120) % 4; else player.frame = 0;
            if(imgPlayer.complete) ctx.drawImage(imgPlayer, player.frame*32, player.dir*32, 32, 32, player.x, player.y, 50, 50);

            // ì ‘ì´‰ íŒì •
            if (Math.hypot(player.x - npc.x, player.y - npc.y) < 45) {
                document.getElementById('game-wrapper').style.display = 'none';
                document.getElementById('ui-layer').style.display = 'block';
                return;
            }
            requestAnimationFrame(loop);
        }

        // --- 78ì¥ íƒ€ë¡œ ë°ì´í„° ---
        const tarotData = [
            {n:"0. ê´‘ëŒ€", i:"RWS_Tarot_00_Fool.jpg"}, {n:"1. ë§ˆë²•ì‚¬", i:"RWS_Tarot_01_Magician.jpg"}, {n:"2. ê³ ìœ„ ì—¬ì‚¬ì œ", i:"RWS_Tarot_02_High_Priestess.jpg"},
            {n:"3. ì—¬í™©ì œ", i:"RWS_Tarot_03_Empress.jpg"}, {n:"4. í™©ì œ", i:"RWS_Tarot_04_Emperor.jpg"}, {n:"5. êµí™©", i:"RWS_Tarot_05_Hierophant.jpg"},
            {n:"6. ì—°ì¸", i:"RWS_Tarot_06_Lovers.jpg"}, {n:"7. ì „ì°¨", i:"RWS_Tarot_07_Chariot.jpg"}, {n:"8. í˜", i:"RWS_Tarot_08_Strength.jpg"},
            {n:"9. ì€ë‘”ì", i:"RWS_Tarot_09_Hermit.jpg"}, {n:"10. ìš´ëª…ì˜ ìˆ˜ë ˆë°”í€´", i:"RWS_Tarot_10_Wheel_of_Fortune.jpg"}, {n:"11. ì •ì˜", i:"RWS_Tarot_11_Justice.jpg"},
            {n:"12. ë§¤ë‹¬ë¦° ì‚¬ëŒ", i:"RWS_Tarot_12_Hanged_Man.jpg"}, {n:"13. ì£½ìŒ", i:"RWS_Tarot_13_Death.jpg"}, {n:"14. ì ˆì œ", i:"RWS_Tarot_14_Temperance.jpg"},
            {n:"15. ì•…ë§ˆ", i:"RWS_Tarot_15_Devil.jpg"}, {n:"16. íƒ‘", i:"RWS_Tarot_16_Tower.jpg"}, {n:"17. ë³„", i:"RWS_Tarot_17_Star.jpg"},
            {n:"18. ë‹¬", i:"RWS_Tarot_18_Moon.jpg"}, {n:"19. íƒœì–‘", i:"RWS_Tarot_19_Sun.jpg"}, {n:"20. ì‹¬íŒ", i:"RWS_Tarot_20_Judgement.jpg"},
            {n:"21. ì„¸ê³„", i:"RWS_Tarot_21_World.jpg"}, {n:"ì™„ë“œ ì—ì´ìŠ¤", i:"Wands01.jpg"}, {n:"ì™„ë“œ 2", i:"Wands02.jpg"},
            {n:"ì™„ë“œ 3", i:"Wands03.jpg"}, {n:"ì™„ë“œ 4", i:"Wands04.jpg"}, {n:"ì™„ë“œ 5", i:"Wands05.jpg"}, {n:"ì™„ë“œ 6", i:"Wands06.jpg"},
            {n:"ì™„ë“œ 7", i:"Wands07.jpg"}, {n:"ì™„ë“œ 8", i:"Wands08.jpg"}, {n:"ì™„ë“œ 9", i:"Tarot_Nine_of_Wands.jpg"}, {n:"ì™„ë“œ 10", i:"Wands10.jpg"},
            {n:"ì™„ë“œ ì‹œì¢…", i:"Wands11.jpg"}, {n:"ì™„ë“œ ê¸°ì‚¬", i:"Wands12.jpg"}, {n:"ì™„ë“œ í€¸", i:"Wands13.jpg"}, {n:"ì™„ë“œ í‚¹", i:"Wands14.jpg"},
            {n:"ì»µ ì—ì´ìŠ¤", i:"Cups01.jpg"}, {n:"ì»µ 2", i:"Cups02.jpg"}, {n:"ì»µ 3", i:"Cups03.jpg"}, {n:"ì»µ 4", i:"Cups04.jpg"},
            {n:"ì»µ 5", i:"Cups05.jpg"}, {n:"ì»µ 6", i:"Cups06.jpg"}, {n:"ì»µ 7", i:"Cups07.jpg"}, {n:"ì»µ 8", i:"Cups08.jpg"},
            {n:"ì»µ 9", i:"Cups09.jpg"}, {n:"ì»µ 10", i:"Cups10.jpg"}, {n:"ì»µ ì‹œì¢…", i:"Cups11.jpg"}, {n:"ì»µ ê¸°ì‚¬", i:"Cups12.jpg"},
            {n:"ì»µ í€¸", i:"Cups13.jpg"}, {n:"ì»µ í‚¹", i:"Cups14.jpg"}, {n:"ì†Œë“œ ì—ì´ìŠ¤", i:"Swords01.jpg"}, {n:"ì†Œë“œ 2", i:"Swords02.jpg"},
            {n:"ì†Œë“œ 3", i:"Swords03.jpg"}, {n:"ì†Œë“œ 4", i:"Swords04.jpg"}, {n:"ì†Œë“œ 5", i:"Swords05.jpg"}, {n:"ì†Œë“œ 6", i:"Swords06.jpg"},
            {n:"ì†Œë“œ 7", i:"Swords07.jpg"}, {n:"ì†Œë“œ 8", i:"Swords08.jpg"}, {n:"ì†Œë“œ 9", i:"Swords09.jpg"}, {n:"ì†Œë“œ 10", i:"Swords10.jpg"},
            {n:"ì†Œë“œ ì‹œì¢…", i:"Swords11.jpg"}, {n:"ì†Œë“œ ê¸°ì‚¬", i:"Swords12.jpg"}, {n:"ì†Œë“œ í€¸", i:"Swords13.jpg"}, {n:"ì†Œë“œ í‚¹", i:"Swords14.jpg"},
            {n:"íœíƒ€í´ ì—ì´ìŠ¤", i:"Pents01.jpg"}, {n:"íœíƒ€í´ 2", i:"Pents02.jpg"}, {n:"íœíƒ€í´ 3", i:"Pents03.jpg"}, {n:"íœíƒ€í´ 4", i:"Pents04.jpg"},
            {n:"íœíƒ€í´ 5", i:"Pents05.jpg"}, {n:"íœíƒ€í´ 6", i:"Pents06.jpg"}, {n:"íœíƒ€í´ 7", i:"Pents07.jpg"}, {n:"íœíƒ€í´ 8", i:"Pents08.jpg"},
            {n:"íœíƒ€í´ 9", i:"Pents09.jpg"}, {n:"íœíƒ€í´ 10", i:"Pents10.jpg"}, {n:"íœíƒ€í´ ì‹œì¢…", i:"Pents11.jpg"}, {n:"íœíƒ€í´ ê¸°ì‚¬", i:"Pents12.jpg"},
            {n:"íœíƒ€í´ í€¸", i:"Pents13.jpg"}, {n:"íœíƒ€í´ í‚¹", i:"Pents14.jpg"}
        ];

        let selected = [];
        let total = 0;

        function startTarot(n) {
            total = n; selected = [];
            document.getElementById('step-input').style.display = 'none';
            document.getElementById('step-tarot').style.display = 'block';
            const box = document.getElementById('cards-box');
            box.innerHTML = '';
            for(let i=0; i<n; i++) {
                box.innerHTML += `
                <div class="card-wrapper">
                    <div class="card-inner" onclick="flip(this, ${i})">
                        <div class="card-face card-front">âœ¦</div>
                        <div class="card-face card-back" id="card-${i}"></div>
                    </div>
                </div>`;
            }
        }

        function flip(el, idx) {
            if(el.classList.contains('is-flipped')) return;
            const data = tarotData[Math.floor(Math.random()*tarotData.length)];
            const isRev = Math.random() > 0.35;
            document.getElementById(`card-${idx}`).innerHTML = `<img src="https://commons.wikimedia.org/wiki/Special:FilePath/${data.i}" style="${isRev?'transform:rotate(180deg)':''}">`;
            el.classList.add('is-flipped');
            selected.push(data.n + (isRev?"(ì—­ë°©í–¥)":"(ì •ë°©í–¥)"));
            if(selected.length === total) {
                document.getElementById('interpret-btn').style.display = 'block';
                document.getElementById('status-msg').innerText = "ì¹´ë“œë¥¼ ëª¨ë‘ ë½‘ìœ¼ì…¨êµ°ìš”. í•´ì„ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.";
            }
        }

        async function getAIInterpretation() {
            const msg = document.getElementById('status-msg');
            msg.innerText = "ğŸ”® ìš°ì£¼ì˜ ê¸°ìš´ì„ ëª¨ì•„ í•´ì„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
            document.getElementById('interpret-btn').style.display = 'none';

            try {
                const res = await fetch('/api/read', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: document.getElementById('user-name').value || "ìµëª…ì˜ ì—¬í–‰ì",
                        question: document.getElementById('user-q').value || "ì „ì²´ìš´",
                        cards: selected
                    })
                });
                const data = await res.json();
                msg.innerText = data.text;
            } catch (e) {
                msg.innerText = "í•´ì„ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ë‹¹ì‹ ì˜ ì•ë‚ ì—” ë¹›ì´ ê°€ë“í•  ê²ƒì…ë‹ˆë‹¤.";
            }
        }

        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);
        imgBg.onload = loop;
    </script>
</body>
</html>
