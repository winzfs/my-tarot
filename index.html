<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCANA TAROT</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #e2b857; --bg: #0a0a0c; }
        body { background: var(--bg); color: #e0e0e0; font-family: 'Noto Sans KR', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        
        /* Î°úÎî© ÌôîÎ©¥ */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:black; display:flex; justify-content:center; align-items:center; z-index:999; color:var(--gold); font-family:'Cinzel'; }

        h1 { font-family: 'Cinzel', serif; color: var(--gold); margin: 15px 0; text-align: center; letter-spacing: 3px; }
        
        #game-container {
            width: 95vw; max-width: 500px; height: 320px;
            border: 2px solid var(--gold); position: relative; border-radius: 15px;
            background: #111; overflow: hidden; touch-action: none;
        }
        #gameCanvas { width: 100%; height: 100%; display: block; image-rendering: pixelated; }

        #mobile-controls { display: grid; grid-template-columns: repeat(3, 65px); gap: 10px; margin-top: 20px; justify-content: center; }
        .ctrl-btn {
            width: 65px; height: 65px; background: rgba(255,255,255,0.1); border: 1px solid var(--gold);
            border-radius: 50%; color: var(--gold); display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; user-select: none;
        }

        #ui-layer { display: none; width: 90%; max-width: 500px; margin-top: 20px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid var(--gold); background: #1a1a1a; color: white; box-sizing: border-box; }
        .mode-card { background: rgba(226, 184, 87, 0.1); border: 1px solid var(--gold); padding: 15px; border-radius: 12px; margin-top: 10px; cursor: pointer; }
        
        .cards-container { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-top: 20px; }
        .card-inner { width: 80px; height: 130px; position: relative; transform-style: preserve-3d; transition: 0.6s; cursor: pointer; }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; border: 1px solid var(--gold); }
        .card-front { background: #1a1a2e; display: flex; align-items: center; justify-content: center; color: var(--gold); font-size: 1.5rem; }
        .card-back { background: white; transform: rotateY(180deg); overflow: hidden; }
        .card-back img { width: 100%; height: 100%; object-fit: cover; }
        
        .result-text { padding: 15px; line-height: 1.8; background: rgba(255,255,255,0.05); border-radius: 12px; margin-top: 15px; border: 1px solid var(--gold); text-align: left; font-size: 0.9rem; }
        .btn { background: var(--gold); color: black; border: none; padding: 12px; border-radius: 25px; font-weight: bold; margin-top: 10px; cursor: pointer; width: 100%; }
    </style>
</head>
<body>

    <div id="loading">LOADING DESTINY...</div>

    <h1>ARCANUM TAROT</h1>

    <div id="game-wrapper">
        <div id="game-container">
            <canvas id="gameCanvas" width="500" height="320"></canvas>
        </div>
        <div id="mobile-controls">
            <div style="grid-column:2" class="ctrl-btn" ontouchstart="keys['ArrowUp']=true" ontouchend="keys['ArrowUp']=false">‚ñ≤</div>
            <div style="grid-column:1" class="ctrl-btn" ontouchstart="keys['ArrowLeft']=true" ontouchend="keys['ArrowLeft']=false">‚óÄ</div>
            <div style="grid-column:2" class="ctrl-btn" ontouchstart="keys['ArrowDown']=true" ontouchend="keys['ArrowDown']=false">‚ñº</div>
            <div style="grid-column:3" class="ctrl-btn" ontouchstart="keys['ArrowRight']=true" ontouchend="keys['ArrowRight']=false">‚ñ∂</div>
        </div>
    </div>

    <div id="ui-layer">
        <div id="input-step">
            <input type="text" id="user-name" placeholder="ÎãπÏã†Ïùò Ïù¥Î¶Ñ">
            <input type="text" id="user-q" placeholder="Î¨¥ÏóáÏù¥ Í∂ÅÍ∏àÌïòÏã≠ÎãàÍπå?">
            <div class="mode-card" onclick="startTarot(1)">Ïò§ÎäòÏùò Ï°∞Ïñ∏ (1Ïû•)</div>
            <div class="mode-card" onclick="startTarot(3)">Í≥ºÍ±∞/ÌòÑÏû¨/ÎØ∏Îûò (3Ïû•)</div>
        </div>
        <div id="tarot-step" style="display:none;">
            <div class="cards-container" id="cards-box"></div>
            <div id="result-box" class="result-text" style="display:none;"></div>
            <button id="ai-btn" class="btn" style="display:none;" onclick="askAI()">Ïö¥Î™ÖÏùò Ìï¥ÏÑù Îì£Í∏∞</button>
            <button class="btn" style="background:#333; color:white;" onclick="location.reload()">Ï≤òÏùåÏúºÎ°ú</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const imgBase = "https://commons.wikimedia.org/wiki/Special:FilePath/";

        // Ïù¥ÎØ∏ÏßÄ Î°úÎî© Í¥ÄÎ¶¨
        let loadedCount = 0;
        const totalImages = 3;
        function imageLoaded() {
            loadedCount++;
            if(loadedCount >= totalImages) {
                document.getElementById('loading').style.display = 'none';
                requestAnimationFrame(gameLoop);
            }
        }

        const bg = new Image();
        bg.crossOrigin = "anonymous";
        bg.src = 'https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?w=500&h=320&fit=crop';
        bg.onload = imageLoaded;
        bg.onerror = imageLoaded; // ÏóêÎü¨ ÎÇòÎèÑ Ïã§ÌñâÎêòÍ≤å Ìï®

        const hero = new Image();
        hero.src = 'https://raw.githubusercontent.com/uheartbeast/youtube-tutorials/master/Action%20RPG/Characters/Player.png';
        hero.onload = imageLoaded;
        hero.onerror = imageLoaded;

        const npc = new Image();
        npc.src = 'https://raw.githubusercontent.com/Deykun/Deykun.github.io/master/assets/images/posts/2019-10-14-rpg-maker-vx-ace-character-generator-guide/hero2.png';
        npc.onload = imageLoaded;
        npc.onerror = imageLoaded;

        let keys = {};
        const p = { x: 50, y: 150, f: 0, d: 0, s: 4 };
        const n = { x: 400, y: 130 };

        function gameLoop() {
            // Î∞∞Í≤Ω Í∑∏Î¶¨Í∏∞
            if(bg.complete && bg.naturalWidth !== 0) {
                ctx.drawImage(bg, 0, 0, 500, 320);
                ctx.fillStyle = "rgba(0,0,0,0.4)";
                ctx.fillRect(0,0,500,320);
            } else {
                ctx.fillStyle = "#1a1a2e";
                ctx.fillRect(0,0,500,320);
            }

            // NPC
            if(npc.complete) ctx.drawImage(npc, 32, 0, 32, 32, n.x, n.y, 60, 60);

            // Ïù¥Îèô
            let moving = false;
            if(keys['ArrowUp'] && p.y > 80) { p.y -= p.s; p.d = 3; moving = true; }
            if(keys['ArrowDown'] && p.y < 250) { p.y += p.s; p.d = 0; moving = true; }
            if(keys['ArrowLeft'] && p.x > 0) { p.x -= p.s; p.d = 1; moving = true; }
            if(keys['ArrowRight'] && p.x < 440) { p.x += p.s; p.d = 2; moving = true; }

            // ÌîåÎ†àÏù¥Ïñ¥
            if(moving) p.f = Math.floor(Date.now()/120) % 4; else p.f = 0;
            if(hero.complete) ctx.drawImage(hero, p.f*32, p.d*32, 32, 32, p.x, p.y, 50, 50);

            // Ï∂©Îèå
            if(Math.hypot(p.x - n.x, p.y - n.y) < 50) {
                document.getElementById('game-wrapper').style.display = 'none';
                document.getElementById('ui-layer').style.display = 'block';
                return;
            }
            requestAnimationFrame(gameLoop);
        }

        // ÌÉÄÎ°ú Îç∞Ïù¥ÌÑ∞ 78Ïû•
        const tarotData = [
            {n:"0. Í¥ëÎåÄ", i:"RWS_Tarot_00_Fool.jpg"}, {n:"1. ÎßàÎ≤ïÏÇ¨", i:"RWS_Tarot_01_Magician.jpg"}, {n:"2. Í≥†ÏúÑÏó¨ÏÇ¨Ï†ú", i:"RWS_Tarot_02_High_Priestess.jpg"}, {n:"3. Ïó¨Ìô©Ï†ú", i:"RWS_Tarot_03_Empress.jpg"}, {n:"4. Ìô©Ï†ú", i:"RWS_Tarot_04_Emperor.jpg"}, {n:"5. ÍµêÌô©", i:"RWS_Tarot_05_Hierophant.jpg"}, {n:"6. Ïó∞Ïù∏", i:"RWS_Tarot_06_Lovers.jpg"}, {n:"7. Ï†ÑÏ∞®", i:"RWS_Tarot_07_Chariot.jpg"}, {n:"8. Ìûò", i:"RWS_Tarot_08_Strength.jpg"}, {n:"9. ÏùÄÎëîÏûê", i:"RWS_Tarot_09_Hermit.jpg"}, {n:"10. Ïö¥Î™ÖÏùò ÏàòÎ†àÎ∞îÌÄ¥", i:"RWS_Tarot_10_Wheel_of_Fortune.jpg"}, {n:"11. Ï†ïÏùò", i:"RWS_Tarot_11_Justice.jpg"}, {n:"12. Îß§Îã¨Î¶∞ ÏÇ¨Îûå", i:"RWS_Tarot_12_Hanged_Man.jpg"}, {n:"13. Ï£ΩÏùå", i:"RWS_Tarot_13_Death.jpg"}, {n:"14. Ï†àÏ†ú", i:"RWS_Tarot_14_Temperance.jpg"}, {n:"15. ÏïÖÎßà", i:"RWS_Tarot_15_Devil.jpg"}, {n:"16. ÌÉë", i:"RWS_Tarot_16_Tower.jpg"}, {n:"17. Î≥Ñ", i:"RWS_Tarot_17_Star.jpg"}, {n:"18. Îã¨", i:"RWS_Tarot_18_Moon.jpg"}, {n:"19. ÌÉúÏñë", i:"RWS_Tarot_19_Sun.jpg"}, {n:"20. Ïã¨Ìåê", i:"RWS_Tarot_20_Judgement.jpg"}, {n:"21. ÏÑ∏Í≥Ñ", i:"RWS_Tarot_21_World.jpg"},
            {n:"ÏôÑÎìú ÏóêÏù¥Ïä§", i:"Wands01.jpg"}, {n:"ÏôÑÎìú 2", i:"Wands02.jpg"}, {n:"ÏôÑÎìú 3", i:"Wands03.jpg"}, {n:"ÏôÑÎìú 4", i:"Wands04.jpg"}, {n:"ÏôÑÎìú 5", i:"Wands05.jpg"}, {n:"ÏôÑÎìú 6", i:"Wands06.jpg"}, {n:"ÏôÑÎìú 7", i:"Wands07.jpg"}, {n:"ÏôÑÎìú 8", i:"Wands08.jpg"}, {n:"ÏôÑÎìú 9", i:"Tarot_Nine_of_Wands.jpg"}, {n:"ÏôÑÎìú 10", i:"Wands10.jpg"}, {n:"ÏôÑÎìú ÏãúÏ¢Ö", i:"Wands11.jpg"}, {n:"ÏôÑÎìú Í∏∞ÏÇ¨", i:"Wands12.jpg"}, {n:"ÏôÑÎìú ÌÄ∏", i:"Wands13.jpg"}, {n:"ÏôÑÎìú ÌÇπ", i:"Wands14.jpg"},
            {n:"Ïªµ ÏóêÏù¥Ïä§", i:"Cups01.jpg"}, {n:"Ïªµ 2", i:"Cups02.jpg"}, {n:"Ïªµ 3", i:"Cups03.jpg"}, {n:"Ïªµ 4", i:"Cups04.jpg"}, {n:"Ïªµ 5", i:"Cups05.jpg"}, {n:"Ïªµ 6", i:"Cups06.jpg"}, {n:"Ïªµ 7", i:"Cups07.jpg"}, {n:"Ïªµ 8", i:"Cups08.jpg"}, {n:"Ïªµ 9", i:"Cups09.jpg"}, {n:"Ïªµ 10", i:"Cups10.jpg"}, {n:"Ïªµ ÏãúÏ¢Ö", i:"Cups11.jpg"}, {n:"Ïªµ Í∏∞ÏÇ¨", i:"Cups12.jpg"}, {n:"Ïªµ ÌÄ∏", i:"Cups13.jpg"}, {n:"Ïªµ ÌÇπ", i:"Cups14.jpg"},
            {n:"ÏÜåÎìú ÏóêÏù¥Ïä§", i:"Swords01.jpg"}, {n:"ÏÜåÎìú 2", i:"Swords02.jpg"}, {n:"ÏÜåÎìú 3", i:"Swords03.jpg"}, {n:"ÏÜåÎìú 4", i:"Swords04.jpg"}, {n:"ÏÜåÎìú 5", i:"Swords05.jpg"}, {n:"ÏÜåÎìú 6", i:"Swords06.jpg"}, {n:"ÏÜåÎìú 7", i:"Swords07.jpg"}, {n:"ÏÜåÎìú 8", i:"Swords08.jpg"}, {n:"ÏÜåÎìú 9", i:"Swords09.jpg"}, {n:"ÏÜåÎìú 10", i:"Swords10.jpg"}, {n:"ÏÜåÎìú ÏãúÏ¢Ö", i:"Swords11.jpg"}, {n:"ÏÜåÎìú Í∏∞ÏÇ¨", i:"Swords12.jpg"}, {n:"ÏÜåÎìú ÌÄ∏", i:"Swords13.jpg"}, {n:"ÏÜåÎìú ÌÇπ", i:"Swords14.jpg"},
            {n:"ÌéúÌÉÄÌÅ¥ ÏóêÏù¥Ïä§", i:"Pents01.jpg"}, {n:"ÌéúÌÉÄÌÅ¥ 2", i:"Pents02.jpg"}, {n:"ÌéúÌÉÄÌÅ¥ 3", i:"Pents03.jpg"}, {n:"ÌéúÌÉÄÌÅ¥ 4", i:"Pents04.jpg"}, {n:"ÌéúÌÉÄÌÅ¥ 5", i:"Pents05.jpg"}, {n:"ÌéúÌÉÄÌÅ¥ 6", i:"Pents06.jpg"}, {n:"ÌéúÌÉÄÌÅ¥ 7", i:"Pents07.jpg"}, {n:"ÌéúÌÉÄÌÅ¥ 8", i:"Pents08.jpg"}, {n:"ÌéúÌÉÄÌÅ¥ 9", i:"Pents09.jpg"}, {n:"ÌéúÌÉÄÌÅ¥ 10", i:"Pents10.jpg"}, {n:"ÌéúÌÉÄÌÅ¥ ÏãúÏ¢Ö", i:"Pents11.jpg"}, {n:"ÌéúÌÉÄÌÅ¥ Í∏∞ÏÇ¨", i:"Pents12.jpg"}, {n:"ÌéúÌÉÄÌÅ¥ ÌÄ∏", i:"Pents13.jpg"}, {n:"ÌéúÌÉÄÌÅ¥ ÌÇπ", i:"Pents14.jpg"}
        ];

        let selected = [];
        let total = 0;

        function startTarot(n) {
            total = n; selected = [];
            document.getElementById('input-step').style.display = 'none';
            document.getElementById('tarot-step').style.display = 'block';
            const box = document.getElementById('cards-box');
            box.innerHTML = '';
            for(let i=0; i<n; i++) {
                box.innerHTML += `<div class="card-inner" id="card-inner-${i}" onclick="flip(${i})"><div class="card-face card-front">‚ú¶</div><div class="card-face card-back" id="back-${i}"></div></div>`;
            }
        }

        function flip(idx) {
            const el = document.getElementById(`card-inner-${idx}`);
            if(el.classList.contains('is-flipped')) return;
            const card = tarotData[Math.floor(Math.random()*tarotData.length)];
            const rev = Math.random() > 0.3;
            document.getElementById(`back-${idx}`).innerHTML = `<img src="${imgBase}${card.i}" style="${rev?'transform:rotate(180deg)':''}">`;
            el.classList.add('is-flipped');
            selected.push(card.n + (rev?"(Ïó≠)":"(Ï†ï)"));
            if(selected.length === total) document.getElementById('ai-btn').style.display = 'block';
        }

        async function askAI() {
            const box = document.getElementById('result-box');
            box.style.display = 'block'; box.innerText = "üîÆ Ïö¥Î™ÖÏùò Ìï¥ÏÑùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...";
            document.getElementById('ai-btn').style.display = 'none';
            try {
                const res = await fetch('/api/read', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: document.getElementById('user-name').value, question: document.getElementById('user-q').value, cards: selected })
                });
                const data = await res.json();
                box.innerText = data.text;
            } catch(e) { box.innerText = "ÌÜµÏã†Ïóê Ïò§Î•òÍ∞Ä ÏÉùÍ≤ºÏßÄÎßå, ÎãπÏã†Ïùò Ïπ¥Îìú Í∏∞Ïö¥ÏùÄ Îß§Ïö∞ ÎßëÏäµÎãàÎã§. [" + selected.join(", ") + "]"; }
        }

        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);
    </script>
</body>
</html>
