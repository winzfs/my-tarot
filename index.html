<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCANA TAROT | Ïã†ÎπÑÎ°úÏö¥ ÌÉÄÎ°úÏ†ê</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #e2b857;
            --gold-glow: rgba(226, 184, 87, 0.3);
            --bg-dark: #0a0a0c;
            --glass: rgba(255, 255, 255, 0.05);
        }

        body {
            background: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 20%, #1a1a2e 0%, var(--bg-dark) 80%);
            color: #e0e0e0; font-family: 'Noto Sans KR', sans-serif;
            margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overflow-x: hidden;
        }

        h1 {
            font-family: 'Cinzel', serif; font-size: 2rem; letter-spacing: 5px; color: var(--gold);
            margin: 20px 0; text-shadow: 0 0 15px var(--gold-glow); text-align: center;
        }

        /* Í≤åÏûÑ Ïª®ÌÖåÏù¥ÎÑà Í∞úÏÑ† */
        #game-container {
            width: 100%; max-width: 500px; height: 300px;
            background: #000; border: 3px solid var(--gold);
            margin: 10px 0; position: relative; border-radius: 15px;
            overflow: hidden; box-shadow: 0 0 30px rgba(0,0,0,0.8);
            touch-action: none;
        }
        #gameCanvas { width: 100%; height: 100%; image-rendering: pixelated; }

        /* Î™®Î∞îÏùº Ïª®Ìä∏Î°§Îü¨ */
        #mobile-controls {
            display: grid; grid-template-columns: repeat(3, 65px); grid-template-rows: repeat(2, 65px);
            gap: 10px; justify-content: center; margin-top: 15px;
        }
        .ctrl-btn {
            width: 65px; height: 65px; background: var(--glass); border: 2px solid var(--gold);
            border-radius: 50%; color: var(--gold); display: flex; align-items: center;
            justify-content: center; font-size: 1.5rem; user-select: none;
            -webkit-tap-highlight-color: transparent; backdrop-filter: blur(5px);
        }
        .ctrl-btn:active { background: var(--gold); color: black; transform: scale(0.9); }
        .up { grid-column: 2; }
        .left { grid-column: 1; grid-row: 2; }
        .down { grid-column: 2; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; }

        @media (min-width: 1024px) { #mobile-controls { display: none; } }

        /* ÏûÖÎ†• Î∞è ÏÑ†ÌÉù ÏòÅÏó≠ */
        #input-area, #mode-selection { width: 100%; max-width: 600px; display: none; margin-bottom: 30px; }
        .user-info-group { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        input[type="text"], input[type="date"] {
            flex: 1; min-width: 150px; padding: 15px; border-radius: 10px; border: 1px solid var(--gold);
            background: var(--glass); color: white; text-align: center; font-size: 1rem; outline: none;
        }

        .mode-card {
            background: var(--glass); border: 1px solid var(--gold);
            padding: 20px; margin: 10px; border-radius: 20px; cursor: pointer;
            transition: 0.4s; width: calc(50% - 20px); display: inline-block;
            vertical-align: top; box-sizing: border-box; text-align: center;
        }
        .mode-card h2 { color: var(--gold); font-size: 1.2rem; margin-top: 0; }

        #tarot-stage { display: none; width: 100%; max-width: 800px; text-align: center; }
        .cards-container { display: flex; justify-content: center; gap: 15px; margin: 20px 0; flex-wrap: wrap; }
        .card-wrapper { flex: 0 0 120px; }
        .card-display { width: 100%; height: 200px; perspective: 1000px; }
        .card-inner { width: 100%; height: 100%; position: relative; transition: 0.8s; transform-style: preserve-3d; cursor: pointer; }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 10px; border: 1px solid var(--gold); overflow: hidden; }
        .card-front { background: #1a1a2e; display: flex; align-items: center; justify-content: center; color: var(--gold); font-size: 2rem; }
        .card-back { transform: rotateY(180deg); background: white; }
        .card-back img { width: 100%; height: 100%; object-fit: cover; }

        .result-text { width: 100%; padding: 25px; background: var(--glass); border-radius: 20px; border: 1px solid var(--gold-glow); margin-top: 20px; }
        button.nav-btn { margin-top: 20px; padding: 12px 30px; background: var(--gold); color: black; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <audio id="bgm" loop><source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-17.mp3"></audio>
    <audio id="sfx-flip"><source src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>

    <h1>ARCANUM TAROT</h1>

    <div id="game-wrapper" style="width:100%; max-width:500px;">
        <div id="game-container">
            <canvas id="gameCanvas" width="500" height="300"></canvas>
        </div>
        <div id="mobile-controls">
            <div class="ctrl-btn up" ontouchstart="keys['ArrowUp']=true" ontouchend="keys['ArrowUp']=false">‚ñ≤</div>
            <div class="ctrl-btn left" ontouchstart="keys['ArrowLeft']=true" ontouchend="keys['ArrowLeft']=false">‚óÄ</div>
            <div class="ctrl-btn down" ontouchstart="keys['ArrowDown']=true" ontouchend="keys['ArrowDown']=false">‚ñº</div>
            <div class="ctrl-btn right" ontouchstart="keys['ArrowRight']=true" ontouchend="keys['ArrowRight']=false">‚ñ∂</div>
        </div>
    </div>

    <div id="input-area">
        <div class="user-info-group">
            <input type="text" id="user-name" placeholder="Ïù¥Î¶Ñ">
            <input type="date" id="user-birth">
        </div>
        <input type="text" id="user-question" placeholder="Î¨¥ÏóáÏù¥ Í∂ÅÍ∏àÌïòÏã†Í∞ÄÏöî?">
    </div>

    <div id="mode-selection">
        <div class="mode-card" onclick="startTarot(1)"><h2>Ïõê Ïπ¥Îìú</h2><p>Ïò§ÎäòÏùò Ï°∞Ïñ∏</p></div>
        <div class="mode-card" onclick="startTarot(3)"><h2>Ïì∞Î¶¨ Ïπ¥Îìú</h2><p>Í≥ºÍ±∞¬∑ÌòÑÏû¨¬∑ÎØ∏Îûò</p></div>
    </div>

    <div id="tarot-stage">
        <div class="cards-container" id="cards-container"></div>
        <div class="result-text" id="result-text">
            <div id="res-name" class="name" style="color:var(--gold); font-weight:bold; margin-bottom:10px;"></div>
            <div id="res-desc" class="desc" style="line-height: 1.8; white-space: pre-wrap; text-align: left;"></div>
        </div>
        <button class="nav-btn" onclick="location.reload()">Îã§Ïãú ÌïòÍ∏∞</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Ïù¥ÎØ∏ÏßÄ Î°úÎìú
        const bgImg = new Image();
        bgImg.src = 'https://img.freepik.com/premium-vector/mystical-astrology-room-with-potions-tarot-cards-crystal-ball-interior-magic-wizard-workshop_333450-435.jpg';
        
        const playerImg = new Image();
        playerImg.src = 'https://opengameart.org/sites/default/files/styles/medium/public/pipo-charachip001.png'; // ÌîΩÏÖÄ Ï∫êÎ¶≠ÌÑ∞ ÏãúÌä∏

        const npcImg = new Image();
        npcImg.src = 'https://opengameart.org/sites/default/files/styles/medium/public/pipo-charachip021.png'; // Ï†êÏÑ±Ïà†ÏÇ¨ Ï∫êÎ¶≠ÌÑ∞

        let keys = {};
        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        const player = { x: 50, y: 200, w: 32, h: 32, frame: 0, dir: 2, speed: 4 };
        const oracle = { x: 420, y: 130, w: 32, h: 32 };

        function drawCharacter(img, x, y, frame, dir) {
            // Ïä§ÌîÑÎùºÏù¥Ìä∏ ÏãúÌä∏Í∞Ä 3x4 Íµ¨Ï°∞Ïùº Îïå ÏûêÎ•¥Îäî Î°úÏßÅ
            const sw = img.width / 3;
            const sh = img.height / 4;
            ctx.drawImage(img, frame * sw, dir * sh, sw, sh, x, y, 40, 50);
        }

        let tick = 0;
        function gameLoop() {
            let moving = false;
            if (keys['ArrowUp'] && player.y > 50) { player.y -= player.speed; player.dir = 3; moving = true; }
            if (keys['ArrowDown'] && player.y < 250) { player.y += player.speed; player.dir = 0; moving = true; }
            if (keys['ArrowLeft'] && player.x > 0) { player.x -= player.speed; player.dir = 1; moving = true; }
            if (keys['ArrowRight'] && player.x < 450) { player.x += player.speed; player.dir = 2; moving = true; }

            if (moving) {
                tick++;
                if (tick % 10 === 0) player.frame = (player.frame + 1) % 3;
            } else {
                player.frame = 1;
            }

            // Í∑∏Î¶¨Í∏∞
            ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height); // Î∞∞Í≤Ω
            
            // Ï†êÏÑ±Ïà†ÏÇ¨ (NPC)
            drawCharacter(npcImg, oracle.x, oracle.y, 1, 0); 
            ctx.fillStyle = "rgba(226, 184, 87, 0.4)";
            ctx.beginPath(); ctx.ellipse(oracle.x+20, oracle.y+45, 15, 5, 0, 0, Math.PI*2); ctx.fill();

            // ÌîåÎ†àÏù¥Ïñ¥
            drawCharacter(playerImg, player.x, player.y, player.frame, player.dir);

            const dist = Math.sqrt(Math.pow(player.x - oracle.x, 2) + Math.pow(player.y - oracle.y, 2));
            if (dist < 40) {
                document.getElementById('game-wrapper').style.display = 'none';
                document.getElementById('input-area').style.display = 'block';
                document.getElementById('mode-selection').style.display = 'block';
                return;
            }
            requestAnimationFrame(gameLoop);
        }

        // ÌÉÄÎ°ú Îç∞Ïù¥ÌÑ∞ Î∞è Î°úÏßÅÏùÄ Ïù¥Ï†ÑÍ≥º ÎèôÏùº (ÏÉùÎûµ ÏóÜÏù¥ tarotData Î∞∞Ïó¥ 78Ïû• Ïú†ÏßÄ)
        const imgBase = "https://commons.wikimedia.org/wiki/Special:FilePath/";
        const tarotData = [ /* ... Ïó¨Í∏∞Ïóê ÏïÑÍπå ÎìúÎ¶∞ 78Ïû• Î¶¨Ïä§Ìä∏Î•º Í∑∏ÎåÄÎ°ú ÎÑ£ÏúºÏãúÎ©¥ Îê©ÎãàÎã§ ... */
            { name: "0. Í¥ëÎåÄ", img: "RWS_Tarot_00_Fool.jpg" }, { name: "1. ÎßàÎ≤ïÏÇ¨", img: "RWS_Tarot_01_Magician.jpg" },
            { name: "2. Í≥†ÏúÑ Ïó¨ÏÇ¨Ï†ú", img: "RWS_Tarot_02_High_Priestess.jpg" }, { name: "3. Ïó¨Ìô©Ï†ú", img: "RWS_Tarot_03_Empress.jpg" },
            { name: "4. Ìô©Ï†ú", img: "RWS_Tarot_04_Emperor.jpg" }, { name: "5. ÍµêÌô©", img: "RWS_Tarot_05_Hierophant.jpg" },
            { name: "6. Ïó∞Ïù∏", img: "RWS_Tarot_06_Lovers.jpg" }, { name: "7. Ï†ÑÏ∞®", img: "RWS_Tarot_07_Chariot.jpg" },
            { name: "8. Ìûò", img: "RWS_Tarot_08_Strength.jpg" }, { name: "9. ÏùÄÎëîÏûê", img: "RWS_Tarot_09_Hermit.jpg" },
            { name: "10. Ïö¥Î™ÖÏùò ÏàòÎ†àÎ∞îÌÄ¥", img: "RWS_Tarot_10_Wheel_of_Fortune.jpg" }, { name: "11. Ï†ïÏùò", img: "RWS_Tarot_11_Justice.jpg" },
            { name: "12. Îß§Îã¨Î¶∞ ÏÇ¨Îûå", img: "RWS_Tarot_12_Hanged_Man.jpg" }, { name: "13. Ï£ΩÏùå", img: "RWS_Tarot_13_Death.jpg" },
            { name: "14. Ï†àÏ†ú", img: "RWS_Tarot_14_Temperance.jpg" }, { name: "15. ÏïÖÎßà", img: "RWS_Tarot_15_Devil.jpg" },
            { name: "16. ÌÉë", img: "RWS_Tarot_16_Tower.jpg" }, { name: "17. Î≥Ñ", img: "RWS_Tarot_17_Star.jpg" },
            { name: "18. Îã¨", img: "RWS_Tarot_18_Moon.jpg" }, { name: "19. ÌÉúÏñë", img: "RWS_Tarot_19_Sun.jpg" },
            { name: "20. Ïã¨Ìåê", img: "RWS_Tarot_20_Judgement.jpg" }, { name: "21. ÏÑ∏Í≥Ñ", img: "RWS_Tarot_21_World.jpg" },
            { name: "ÏôÑÎìú ÏóêÏù¥Ïä§", img: "Wands01.jpg" }, { name: "ÏôÑÎìú 2", img: "Wands02.jpg" }, { name: "ÏôÑÎìú 3", img: "Wands03.jpg" }, { name: "ÏôÑÎìú 4", img: "Wands04.jpg" }, { name: "ÏôÑÎìú 5", img: "Wands05.jpg" }, { name: "ÏôÑÎìú 6", img: "Wands06.jpg" }, { name: "ÏôÑÎìú 7", img: "Wands07.jpg" }, { name: "ÏôÑÎìú 8", img: "Wands08.jpg" }, { name: "ÏôÑÎìú 9", img: "Tarot_Nine_of_Wands.jpg" }, { name: "ÏôÑÎìú 10", img: "Wands10.jpg" }, { name: "ÏôÑÎìú ÏãúÏ¢Ö", img: "Wands11.jpg" }, { name: "ÏôÑÎìú Í∏∞ÏÇ¨", img: "Wands12.jpg" }, { name: "ÏôÑÎìú ÌÄ∏", img: "Wands13.jpg" }, { name: "ÏôÑÎìú ÌÇπ", img: "Wands14.jpg" },
            { name: "Ïªµ ÏóêÏù¥Ïä§", img: "Cups01.jpg" }, { name: "Ïªµ 2", img: "Cups02.jpg" }, { name: "Ïªµ 3", img: "Cups03.jpg" }, { name: "Ïªµ 4", img: "Cups04.jpg" }, { name: "Ïªµ 5", img: "Cups05.jpg" }, { name: "Ïªµ 6", img: "Cups06.jpg" }, { name: "Ïªµ 7", img: "Cups07.jpg" }, { name: "Ïªµ 8", img: "Cups08.jpg" }, { name: "Ïªµ 9", img: "Cups09.jpg" }, { name: "Ïªµ 10", img: "Cups10.jpg" }, { name: "Ïªµ ÏãúÏ¢Ö", img: "Cups11.jpg" }, { name: "Ïªµ Í∏∞ÏÇ¨", img: "Cups12.jpg" }, { name: "Ïªµ ÌÄ∏", img: "Cups13.jpg" }, { name: "Ïªµ ÌÇπ", img: "Cups14.jpg" },
            { name: "ÏÜåÎìú ÏóêÏù¥Ïä§", img: "Swords01.jpg" }, { name: "ÏÜåÎìú 2", img: "Swords02.jpg" }, { name: "ÏÜåÎìú 3", img: "Swords03.jpg" }, { name: "ÏÜåÎìú 4", img: "Swords04.jpg" }, { name: "ÏÜåÎìú 5", img: "Swords05.jpg" }, { name: "ÏÜåÎìú 6", img: "Swords06.jpg" }, { name: "ÏÜåÎìú 7", img: "Swords07.jpg" }, { name: "ÏÜåÎìú 8", img: "Swords08.jpg" }, { name: "ÏÜåÎìú 9", img: "Swords09.jpg" }, { name: "ÏÜåÎìú 10", img: "Swords10.jpg" }, { name: "ÏÜåÎìú ÏãúÏ¢Ö", img: "Swords11.jpg" }, { name: "ÏÜåÎìú Í∏∞ÏÇ¨", img: "Swords12.jpg" }, { name: "ÏÜåÎìú ÌÄ∏", img: "Swords13.jpg" }, { name: "ÏÜåÎìú ÌÇπ", img: "Swords14.jpg" },
            { name: "ÌéúÌÉÄÌÅ¥ ÏóêÏù¥Ïä§", img: "Pents01.jpg" }, { name: "ÌéúÌÉÄÌÅ¥ 2", img: "Pents02.jpg" }, { name: "ÌéúÌÉÄÌÅ¥ 3", img: "Pents03.jpg" }, { name: "ÌéúÌÉÄÌÅ¥ 4", img: "Pents04.jpg" }, { name: "ÌéúÌÉÄÌÅ¥ 5", img: "Pents05.jpg" }, { name: "ÌéúÌÉÄÌÅ¥ 6", img: "Pents06.jpg" }, { name: "ÌéúÌÉÄÌÅ¥ 7", img: "Pents07.jpg" }, { name: "ÌéúÌÉÄÌÅ¥ 8", img: "Pents08.jpg" }, { name: "ÌéúÌÉÄÌÅ¥ 9", img: "Pents09.jpg" }, { name: "ÌéúÌÉÄÌÅ¥ 10", img: "Pents10.jpg" }, { name: "ÌéúÌÉÄÌÅ¥ ÏãúÏ¢Ö", img: "Pents11.jpg" }, { name: "ÌéúÌÉÄÌÅ¥ Í∏∞ÏÇ¨", img: "Pents12.jpg" }, { name: "ÌéúÌÉÄÌÅ¥ ÌÄ∏", img: "Pents13.jpg" }, { name: "ÌéúÌÉÄÌÅ¥ ÌÇπ", img: "Pents14.jpg" }
        ];

        let selectedCards = [];
        let totalCount = 0;

        function startTarot(count) {
            totalCount = count;
            selectedCards = [];
            document.getElementById('mode-selection').style.display = 'none';
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('tarot-stage').style.display = 'block';
            
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            const labels = count === 3 ? ["Í≥ºÍ±∞", "ÌòÑÏû¨", "ÎØ∏Îûò"] : ["Ïò§ÎäòÏùò Ïã†ÌÉÅ"];
            for(let i=0; i<count; i++) {
                container.innerHTML += `<div class="card-wrapper"><div class="label" style="color:var(--gold); margin-bottom:5px;">${labels[i]}</div><div class="card-display"><div class="card-inner" onclick="flipCard(this, ${i})"><div class="card-face card-front">‚ú¶</div><div class="card-face card-back" id="back-${i}"></div></div></div></div>`;
            }
        }

        async function flipCard(el, idx) {
            if (el.classList.contains('is-flipped')) return;
            document.getElementById('bgm').play().catch(()=>{});
            document.getElementById('sfx-flip').currentTime = 0;
            document.getElementById('sfx-flip').play();

            const card = tarotData[Math.floor(Math.random() * tarotData.length)];
            const isReverse = Math.random() > 0.3;
            const displayName = card.name + (isReverse ? " (Ïó≠Î∞©Ìñ•)" : " (Ï†ïÎ∞©Ìñ•)");
            
            el.closest('.card-wrapper').querySelector('.label').innerText = displayName;
            document.getElementById(`back-${idx}`).innerHTML = `<img src="${imgBase}${card.img}" style="${isReverse?'transform:rotate(180deg)':''}; width:100%; height:100%; object-fit:cover;">`;
            el.classList.add('is-flipped');
            selectedCards.push(displayName);

            if (selectedCards.length === totalCount) {
                document.getElementById('res-desc').innerHTML = `<button class="nav-btn" style="width:100%" onclick="getFinalAIReading()">Ìï¥ÏÑù Î≥¥Í∏∞</button>`;
            }
        }

        async function getFinalAIReading() {
            const btn = event.target;
            btn.disabled = true; btn.innerText = "üîÆ ÏùΩÎäî Ï§ë...";
            try {
                const response = await fetch('/api/read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('user-name').value || "Ïó¨ÌñâÏûê",
                        birth: document.getElementById('user-birth').value,
                        question: document.getElementById('user-question').value || "Ï†ÑÏ≤¥ Ïö¥ÏÑ∏",
                        cards: selectedCards
                    })
                });
                const data = await response.json();
                document.getElementById('res-name').innerText = "AIÏùò Ïã†ÌÉÅ";
                document.getElementById('res-desc').innerText = data.text;
                btn.style.display = 'none';
            } catch (e) {
                document.getElementById('res-desc').innerText = "Ìï¥ÏÑùÏùÑ Í∞ÄÏ†∏Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.";
                btn.disabled = false;
            }
        }

        // Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÌõÑ Î£®ÌîÑ ÏãúÏûë
        let loaded = 0;
        [bgImg, playerImg, npcImg].forEach(img => {
            img.onload = () => { if(++loaded === 3) gameLoop(); };
        });
    </script>
</body>
</html>
